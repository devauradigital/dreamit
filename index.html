<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dreamit">
    
    <title>Dreamit</title>
    <link rel="manifest" href="/site.webmanifest">
    <link rel="apple-touch-icon" href="/navbarlogo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1a1a1a;
            color: #e5e7eb;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .card {
            transition: all 0.3s ease;
            background-color: #2d2d2d;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }
        .goal-card {
            cursor: pointer;
        }
        .goal-card.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }
        .progress-bar {
            transition: width 1s ease-in-out;
            background-color: #3b82f6 !important;
        }
        .milestone-checkbox:checked + label {
            text-decoration: line-through;
            color: #9ca3af;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn {
            transition: all 0.3s ease;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
        }
        .btn-secondary {
            color: #9ca3af;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .btn-danger:hover {
            background-color: rgba(239, 68, 68, 0.1);
        }
        .btn-edit:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        .input-field, .select-field, .textarea-field {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #4b5563;
            border-radius: 0.375rem;
            background-color: #2d2d2d;
            color: #e5e7eb;
            transition: all 0.3s ease;
        }
        .input-field:focus, .select-field:focus, .textarea-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #3b82f6;
        }
        .text-gray-400 {
            color: #9ca3af !important;
        }
        .text-gray-200 {
            color: #e5e7eb !important;
        }
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        .spinner {
            border: 4px solid rgba(59, 130, 246, 0.2);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .nav-tabs {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .nav-tabs::-webkit-scrollbar {
            display: none;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-height: 300px;
        }
        @media (max-width: 768px) {
            .tab-btn {
                font-size: 0.875rem;
            }
            .chart-container {
                max-height: 350px;
            }
        }
    </style>
</head>

<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="mb-10">
            <div class="flex justify-between items-center">
                <div>
                    <img src="navbarlogo.png" alt="Goal Tracker Logo" class="h-10 w-auto">
                </div>
            </div>
            <p class="text-gray-300 mt-2">Your companion for reaching your goals</p>
        </header>

        <!-- Navigation -->
        <nav class="mb-8 border-b" style="border-color: #4b5563;">
            <ul class="nav-tabs flex space-x-4 sm:space-x-8 overflow-x-auto md:overflow-visible">
                <li><button class="tab-btn active py-2 px-1 border-b-2 border-blue-400 text-blue-400 text-sm sm:text-base" data-tab="dashboard" aria-selected="true">Dashboard</button></li>
                <li class="ml-auto"><button class="tab-btn py-2 px-1 text-gray-400 text-sm sm:text-base" data-tab="settings" aria-selected="false">Settings</button></li>
            </ul>
        </nav>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div id="loadingSpinner" class="loading-spinner">
                <div class="spinner"></div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 hidden" id="goalsContainer"></div>
            <div id="noGoalsMessage" class="text-center py-20 hidden">
                <img src="no_goal.png" alt="No goals yet illustration" class="mx-auto mb-4 rounded-lg" style="width: 300px; height: 200px;">
                <h3 class="text-xl font-semibold text-gray-200">No goals yet</h3>
                <p class="text-gray-400 mb-4">Create your first goal to begin your journey.</p>
                <button id="createFirstGoalBtn" class="btn btn-primary">Create Your First Goal</button>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content hidden">
            <!-- User Profile -->
            <div class="card p-6 mb-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-200">Profile</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Name</label>
                        <input type="text" id="userName" class="input-field" placeholder="Your name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Height (cm)</label>
                        <input type="number" id="userHeight" class="input-field" min="100" max="250" placeholder="170">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Weight (kg)</label>
                        <input type="number" id="userWeight" class="input-field" min="30" max="200" step="0.1" placeholder="65">
                    </div>
                    <div class="md:col-span-2">
                        <button id="saveProfileBtn" class="btn btn-primary mt-2">Save Profile</button>
                    </div>
                </div>
            </div>

            <!-- Notes Section -->
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-200">My Notes</h3>
                    <button id="addNoteBtn" class="btn btn-primary text-sm">+ New Note</button>
                </div>
                <div id="notesList" class="space-y-4"></div>
            </div>
        </div>

        <!-- Goal Modal -->
        <div id="goalModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" role="dialog" aria-labelledby="modalTitle">
            <div class="card rounded-xl p-6 w-full max-w-md mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modalTitle" class="text-xl font-semibold" style="color: #e5e7eb;">Create New Goal</h3>
                    <button id="closeModalBtn" class="text-gray-400 hover:text-gray-200" aria-label="Close modal">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <form id="goalForm">
                    <input type="hidden" id="editGoalId">
                    <div class="mb-4">
                        <label for="goalTitle" class="block text-sm font-medium mb-1" style="color: #9ca3af;">Goal Title</label>
                        <input type="text" id="goalTitle" required class="input-field" placeholder="Enter goal title" aria-describedby="goalTitleError">
                        <p id="goalTitleError" class="error-message">Goal title is required</p>
                    </div>
                    <div class="mb-4">
                        <label for="goalDescription" class="block text-sm font-medium mb-1" style="color: #9ca3af;">Description</label>
                        <textarea id="goalDescription" class="textarea-field" rows="4" placeholder="Enter goal description"></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="goalCategory" class="block text-sm font-medium mb-1" style="color: #9ca3af;">Category</label>
                        <select id="goalCategory" class="select-field" required aria-describedby="goalCategoryError">
                            <option value="">Select Category</option>
                            <option value="health">Health</option>
                            <option value="career">Career</option>
                            <option value="finance">Finance</option>
                            <option value="personal">Personal Growth</option>
                        </select>
                        <p id="goalCategoryError" class="error-message">Please select a category</p>
                    </div>
                    <div id="financeAmountField" class="mb-4 hidden">
                        <label for="targetAmount" class="block text-sm font-medium mb-1" style="color: #9ca3af;">Target Amount (₹)</label>
                        <input type="number" id="targetAmount" min="1" step="1" class="input-field" placeholder="Enter target amount" aria-describedby="targetAmountError">
                        <p id="targetAmountError" class="error-message">Please enter a valid target amount</p>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancelGoalBtn" class="btn btn-secondary">Cancel</button>
                        <button type="submit" id="submitGoalBtn" class="btn btn-primary">Create Goal</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Goal Detail Modal -->
        <div id="goalDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" role="dialog" aria-labelledby="detailGoalTitle">
            <div class="card rounded-xl p-6 w-full max-w-md mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="detailGoalTitle" class="text-xl font-semibold" style="color: #e5e7eb;"></h3>
                    <div class="flex space-x-2">
                        <button id="editGoalBtn" class="text-gray-400 hover:text-gray-200" title="Edit Goal" aria-label="Edit Goal">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </button>
                        <button id="closeDetailModalBtn" class="text-gray-400 hover:text-gray-200" aria-label="Close modal">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="mb-4">
                    <p id="detailDescription" class="text-sm" style="color: #9ca3af;"></p>
                </div>
                <div class="mb-4">
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-blue-400">Progress</span>
                        <span id="progressPercentage" class="text-sm font-medium" style="color: #e5e7eb;">0%</span>
                    </div>
                    <div class="w-full bg-gray-600 rounded-full h-2.5" style="background-color: #4b5563;">
                        <div id="detailProgressBar" class="bg-blue-500 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                    <div id="financeProgressText" class="text-sm mt-2 hidden" style="color: #9ca3af;">
                        Current: ₹<span id="currentAmountDisplay">0</span> / ₹<span id="targetAmountDisplay">0</span>
                    </div>
                </div>
                <div class="flex items-center text-sm mb-3" style="color: #9ca3af;">
                    <span id="detailCategory" class="px-2 py-1 text-xs rounded-full"></span>
                </div>
                <div id="milestoneSection" class="hidden">
                    <h4 class="font-medium mb-3" style="color: #e5e7eb;">Milestones</h4>
                    <div id="milestonesList" class="space-y-2 mb-4"></div>
                    <div class="flex">
                        <input type="text" id="newMilestoneInput" placeholder="Add a new milestone" class="input-field flex-grow rounded-l-md" aria-label="New milestone">
                        <button id="addMilestoneBtn" class="btn btn-primary rounded-l-none">Add</button>
                    </div>
                </div>
                <div id="financeSliderSection" class="hidden">
                    <h4 class="font-medium mb-3" style="color: #e5e7eb;">Current Amount (₹)</h4>
                    <input type="range" id="currentAmountSlider" min="0" max="10000" value="0" class="input-field mb-2" aria-label="Current amount">
                    <div class="flex justify-between text-sm mb-2" style="color: #9ca3af;">
                        <span id="currentAmountLabel">₹0</span>
                        <span id="targetAmountLabel">₹10000</span>
                    </div>
                    <div class="flex items-center">
                        <input type="number" id="currentAmountInput" min="0" step="1" class="input-field" placeholder="Enter current amount" aria-label="Current amount input">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="deleteGoalBtn" class="btn btn-danger text-red-400">Delete Goal</button>
                </div>
            </div>
        </div>

        <!-- Note Modal -->
        <div id="noteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" role="dialog">
            <div class="card rounded-xl p-6 w-full max-w-lg mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="noteModalTitle" class="text-xl font-semibold text-gray-200">New Note</h3>
                    <button id="closeNoteModal" class="text-gray-400 hover:text-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <form id="noteForm">
                    <input type="hidden" id="noteId">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-400 mb-1">Title</label>
                        <input type="text" id="noteTitle" class="input-field" placeholder="Untitled Note">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-400 mb-1">Content</label>
                        <textarea id="noteContent" class="textarea-field" rows="6" placeholder="Write your thoughts..."></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancelNoteBtn" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Note</button>
                    </div>
                </form>
            </div>
        </div>

        <footer class="mt-10 py-4 text-center text-gray-400">
            <p>Powered By <a href="https://devauradigital.com" target="_blank" class="text-blue-400 hover:text-blue-500 transition">DevAura Digital</a></p>
        </footer>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyA3Y1aDGpyKD1QM50GpPsl6OsvK026zmOU",
            authDomain: "goal-tracker-1725.firebaseapp.com",
            databaseURL: "https://goal-tracker-1725-default-rtdb.firebaseio.com",
            projectId: "goal-tracker-1725",
            storageBucket: "goal-tracker-1725.firebasestorage.app",
            messagingSenderId: "1071901848843",
            appId: "1:1071901848843:web:55c4186244e40f8b131e0e",
            measurementId: "G-9RD6ZZ02EY"
        };

        let database;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
        } catch (e) {
            console.error('Firebase init error', e);
            alert('Firebase failed to start.');
        }

        // Password Overlay (with name)
        const passwordOverlayHTML = `
            <div id="pwdOverlay" class="fixed inset-0 bg-gradient-to-br from-blue-900 via-blue-700 to-indigo-800 flex items-center justify-center z-[9999] p-4">
                <div class="card rounded-2xl p-8 w-full max-w-md mx-auto shadow-2xl bg-gray-900/95 backdrop-blur-sm border border-blue-700/30">
                    <div class="flex justify-center mb-6">
                        <img src="navbarlogo.png" alt="Dreamit Logo" class="h-16 w-auto">
                    </div>
                    <h1 class="text-2xl font-bold text-center text-gray-100 mb-2">
                        Welcome back<span id="welcomeName">!</span>
                    </h1>
                    <p class="text-center text-gray-400 mb-8">Enter your Dreamit password</p>
                    <div class="mb-5">
                        <input type="password" id="pwdInput" 
                               class="input-field w-full text-lg px-4 py-3 rounded-lg bg-gray-800 border border-gray-600 text-white placeholder-gray-500 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/30 transition"
                               placeholder="••••••••" autofocus>
                    </div>
                    <p id="pwdError" class="error-message text-red-400 text-sm text-center mb-4" style="display:none;"></p>
                    <button id="pwdSubmit" class="btn btn-primary w-full py-3 text-lg font-medium rounded-lg shadow-lg hover:shadow-blue-500/25 transition transform hover:-translate-y-0.5">
                        Unlock Dreamit
                    </button>
                    <p class="text-center text-xs text-gray-500 mt-6">
                        Powered by <span class="text-blue-400">Devaura Digital</span>
                    </p>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('afterbegin', passwordOverlayHTML);

        const pwdOverlay = document.getElementById('pwdOverlay');
        const pwdInput = document.getElementById('pwdInput');
        const pwdSubmit = document.getElementById('pwdSubmit');
        const pwdError = document.getElementById('pwdError');

        // Update welcome name
        async function updateWelcomeName() {
            const profileRef = database.ref('userProfile');
            const snap = await profileRef.once('value');
            const data = snap.val();
            const name = data?.name?.trim() || 'there';
            const el = document.getElementById('welcomeName');
            if (el) el.textContent = `, ${name}!`;
        }

        async function sha256(str) {
            const encoder = new TextEncoder();
            const data = encoder.encode(str);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        const PW_PATH = 'appPassword';
        let isUnlocked = false;

        async function loadPasswordHash() {
            const snap = await database.ref(PW_PATH).once('value');
            return snap.val();
        }

        async function setInitialPassword(pwd) {
            const hash = await sha256(pwd);
            await database.ref(PW_PATH).set(hash);
            return hash;
        }

        async function verifyPassword(pwd) {
            const stored = await loadPasswordHash();
            if (!stored) return false;
            const inputHash = await sha256(pwd);
            return inputHash === stored;
        }

        async function attemptUnlock() {
            const pwd = pwdInput.value.trim();
            if (!pwd) { pwdError.textContent = 'Password required'; pwdError.style.display='block'; return; }

            const stored = await loadPasswordHash();
            if (!stored) {
                if (confirm('No password exists. Set this as the app password?')) {
                    await setInitialPassword(pwd);
                    unlockApp();
                }
                return;
            }

            const ok = await verifyPassword(pwd);
            if (ok) unlockApp();
            else { pwdError.textContent = 'Incorrect password'; pwdError.style.display='block'; }
        }

        function unlockApp() {
            isUnlocked = true;
            pwdOverlay.remove();
            document.body.style.visibility = 'visible';
            initApp();
            updateWelcomeName(); // Show name after unlock
        }

        pwdSubmit.addEventListener('click', attemptUnlock);
        pwdInput.addEventListener('keydown', e => { if (e.key === 'Enter') attemptUnlock(); });

        document.body.style.visibility = 'hidden';
        pwdOverlay.style.visibility = 'visible';

        // Load name on first render
        updateWelcomeName();

        // MAIN APP
        function initApp() {
            const elements = {
                dashboardTab: document.getElementById('dashboard'),
                tabBtns: document.querySelectorAll('.tab-btn'),
                goalsContainer: document.getElementById('goalsContainer'),
                noGoalsMessage: document.getElementById('noGoalsMessage'),
                goalModal: document.getElementById('goalModal'),
                goalDetailModal: document.getElementById('goalDetailModal'),
                goalForm: document.getElementById('goalForm'),
                createFirstGoalBtn: document.getElementById('createFirstGoalBtn'),
                closeModalBtn: document.getElementById('closeModalBtn'),
                cancelGoalBtn: document.getElementById('cancelGoalBtn'),
                closeDetailModalBtn: document.getElementById('closeDetailModalBtn'),
                editGoalBtn: document.getElementById('editGoalBtn'),
                deleteGoalBtn: document.getElementById('deleteGoalBtn'),
                addMilestoneBtn: document.getElementById('addMilestoneBtn'),
                newMilestoneInput: document.getElementById('newMilestoneInput'),
                goalCategorySelect: document.getElementById('goalCategory'),
                financeAmountField: document.getElementById('financeAmountField'),
                targetAmountInput: document.getElementById('targetAmount'),
                milestoneSection: document.getElementById('milestoneSection'),
                financeSliderSection: document.getElementById('financeSliderSection'),
                currentAmountSlider: document.getElementById('currentAmountSlider'),
                currentAmountInput: document.getElementById('currentAmountInput'),
                currentAmountLabel: document.getElementById('currentAmountLabel'),
                targetAmountLabel: document.getElementById('targetAmountLabel'),
                currentAmountDisplay: document.getElementById('currentAmountDisplay'),
                targetAmountDisplay: document.getElementById('targetAmountDisplay'),
                modalTitle: document.getElementById('modalTitle'),
                submitGoalBtn: document.getElementById('submitGoalBtn'),
                editGoalId: document.getElementById('editGoalId'),
                goalTitle: document.getElementById('goalTitle'),
                goalDescription: document.getElementById('goalDescription'),
                detailDescription: document.getElementById('detailDescription'),
                progressPercentage: document.getElementById('progressPercentage'),
                detailProgressBar: document.getElementById('detailProgressBar'),
                detailGoalTitle: document.getElementById('detailGoalTitle'),
                detailCategory: document.getElementById('detailCategory'),
                milestonesList: document.getElementById('milestonesList'),
                goalTitleError: document.getElementById('goalTitleError'),
                goalCategoryError: document.getElementById('goalCategoryError'),
                targetAmountError: document.getElementById('targetAmountError'),
                loadingSpinner: document.getElementById('loadingSpinner'),
                userName: document.getElementById('userName'),
                userHeight: document.getElementById('userHeight'),
                userWeight: document.getElementById('userWeight'),
                saveProfileBtn: document.getElementById('saveProfileBtn'),
                addNoteBtn: document.getElementById('addNoteBtn'),
                notesList: document.getElementById('notesList'),
                noteModal: document.getElementById('noteModal'),
                noteModalTitle: document.getElementById('noteModalTitle'),
                noteForm: document.getElementById('noteForm'),
                noteId: document.getElementById('noteId'),
                noteTitle: document.getElementById('noteTitle'),
                noteContent: document.getElementById('noteContent'),
                closeNoteModal: document.getElementById('closeNoteModal'),
                cancelNoteBtn: document.getElementById('cancelNoteBtn')
            };

            let goals = [];
            let currentGoalId = null;
            let notes = [];

            const profileRef = database.ref('userProfile');
            const notesRef = database.ref('notes');

            // Utility Functions
            const formatCurrency = (amount) => isNaN(amount) ? '0' : amount.toLocaleString('en-IN');
            const getCategoryInfo = (category) => ({
                name: ({ health: 'Health', career: 'Career', finance: 'Finance', personal: 'Personal Growth' }[category] || 'Other'),
                color: ({ health: 'bg-green-900 text-green-300', career: 'bg-purple-900 text-purple-300', finance: 'bg-blue-900 text-blue-300', personal: 'bg-pink-900 text-pink-300' }[category] || 'bg-gray-900 text-gray-300')
            });
            const debounce = (func, wait) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func(...args), wait);
                };
            };
            const sanitizeGoal = (goal) => ({
                id: goal.id && !/[.#$/\[\]]/.test(goal.id) ? goal.id : database.ref('goals').push().key,
                title: goal.title || '',
                description: goal.description || '',
                category: goal.category || '',
                progress: Number(goal.progress) || 0,
                milestones: Array.isArray(goal.milestones) ? goal.milestones.map(m => ({
                    id: Number(m.id) || 1,
                    text: m.text || '',
                    completed: !!m.completed
                })) : [],
                targetAmount: goal.category === 'finance' ? Number(goal.targetAmount) || null : null,
                currentAmount: goal.category === 'finance' ? Number(goal.currentAmount) || 0 : null,
                order: Number(goal.order) || 0,
                createdAt: goal.createdAt || new Date().toISOString(),
                progressHistory: goal.progressHistory || []
            });
            const handleError = (error, action) => {
                console.error(`Error ${action}:`, error);
                let message = `Failed to ${action}. `;
                if (error.code === 'PERMISSION_DENIED') message += 'Permission denied.';
                else message += `Error: ${error.message}`;
                alert(message);
                throw error;
            };
            const openModal = (modalElement, titleElement, title, submitButton, submitText, focusElement) => {
                if (!modalElement || !titleElement || !submitButton || !focusElement) return;
                titleElement.textContent = title;
                submitButton.textContent = submitText;
                modalElement.classList.remove('hidden');
                focusElement.focus();
            };
            const closeModal = (modalElement, formElement, errorElements = []) => {
                if (!modalElement) return;
                modalElement.classList.add('hidden');
                if (formElement) formElement.reset();
                errorElements.forEach(el => { if (el) el.style.display = 'none'; });
            };
            const validateForm = (fields) => {
                let hasError = false;
                fields.forEach(({ value, errorElement, errorMessage, validate }) => {
                    if (!errorElement) return;
                    const isValid = validate(value);
                    errorElement.style.display = isValid ? 'none' : 'block';
                    errorElement.textContent = errorMessage;
                    if (!isValid) hasError = true;
                });
                return !hasError;
            };

            // Data Management
            const saveData = async (path, data) => {
                if (!database) throw new Error('Database not initialized');
                const updates = {};
                data.forEach((item, index) => {
                    const sanitizedItem = { ...item };
                    delete sanitizedItem.timer;
                    delete sanitizedItem.intervalTimer;
                    updates[`${path}/${item.id}`] = { ...sanitizedItem, order: index };
                });
                await database.ref().update(updates).catch(error => handleError(error, `save ${path}`));
            };
            const loadData = async (path, array, processItem) => {
                if (!database) throw new Error('Database not initialized');
                if (elements.loadingSpinner) elements.loadingSpinner.classList.remove('hidden');
                try {
                    const snapshot = await database.ref(path).once('value');
                    array.length = 0;
                    snapshot.forEach(childSnapshot => {
                        const item = childSnapshot.val();
                        processItem(item);
                        array.push(item);
                    });
                    array.sort((a, b) => a.order - b.order);
                } catch (error) {
                    handleError(error, `load ${path}`);
                } finally {
                    if (elements.loadingSpinner) elements.loadingSpinner.classList.add('hidden');
                }
            };

            // Goal Functions
            const updateGoalProgress = (goal) => {
                if (!goal) return;
                if (goal.category === 'finance') {
                    goal.progress = goal.targetAmount && goal.targetAmount !== 0 ?
                        Math.min(100, Math.round((goal.currentAmount || 0) / goal.targetAmount * 100)) : 0;
                } else {
                    goal.progress = goal.milestones && goal.milestones.length ?
                        Math.round((goal.milestones.filter(m => m.completed).length / goal.milestones.length) * 100) : 0;
                }
                goal.progressHistory = goal.progressHistory || [];
                goal.progressHistory.push({
                    timestamp: new Date().toISOString(),
                    progress: goal.progress
                });
                if (currentGoalId === goal.id) updateGoalDetailModal(goal);
                updateGoalCard(goal);
            };
            const updateGoalCard = (goal) => {
                if (!goal) return;
                const goalCard = elements.goalsContainer.querySelector(`.goal-card[data-id="${goal.id}"]`);
                if (!goalCard) return;
                const progressBar = goalCard.querySelector('.progress-bar');
                const progressText = goalCard.querySelector('.progress-text');
                const description = goalCard.querySelector('.goal-description');
                if (progressBar) progressBar.style.width = `${goal.progress}%`;
                if (progressText) progressText.textContent = `${goal.progress}%`;
                if (description) description.textContent = goal.description || '';
                if (goal.category === 'finance') {
                    const financeTarget = goalCard.querySelector('.finance-target');
                    if (financeTarget) financeTarget.textContent = `Current: ₹${formatCurrency(goal.currentAmount)} / ₹${formatCurrency(goal.targetAmount)}`;
                }
            };
            const updateGoalDetailModal = (goal) => {
                if (!goal) return;
                const { name, color } = getCategoryInfo(goal.category);
                if (elements.detailGoalTitle) elements.detailGoalTitle.textContent = goal.title || 'Untitled';
                if (elements.detailDescription) elements.detailDescription.textContent = goal.description || '';
                if (elements.detailCategory) {
                    elements.detailCategory.textContent = name;
                    elements.detailCategory.className = `px-2 py-1 text-xs rounded-full ${color}`;
                }
                if (elements.progressPercentage) elements.progressPercentage.textContent = `${goal.progress}%`;
                if (elements.detailProgressBar) elements.detailProgressBar.style.width = `${goal.progress}%`;
                if (elements.milestoneSection) elements.milestoneSection.classList.toggle('hidden', goal.category === 'finance');
                if (elements.financeSliderSection) elements.financeSliderSection.classList.toggle('hidden', goal.category !== 'finance');
                if (elements.financeProgressText) elements.financeProgressText.classList.toggle('hidden', goal.category !== 'finance');
                if (goal.category === 'finance') {
                    const target = goal.targetAmount || 10000;
                    if (elements.currentAmountSlider) {
                        elements.currentAmountSlider.max = target;
                        elements.currentAmountSlider.value = goal.currentAmount || 0;
                    }
                    if (elements.currentAmountInput) {
                        elements.currentAmountInput.max = target;
                        elements.currentAmountInput.value = goal.currentAmount || 0;
                    }
                    if (elements.currentAmountLabel) elements.currentAmountLabel.textContent = `₹${formatCurrency(goal.currentAmount || 0)}`;
                    if (elements.targetAmountLabel) elements.targetAmountLabel.textContent = `₹${formatCurrency(target)}`;
                    if (elements.currentAmountDisplay) elements.currentAmountDisplay.textContent = formatCurrency(goal.currentAmount || 0);
                    if (elements.targetAmountDisplay) elements.targetAmountDisplay.textContent = formatCurrency(target);
                } else {
                    if (elements.milestonesList) {
                        elements.milestonesList.innerHTML = '';
                        (goal.milestones || []).forEach(milestone => {
                            const milestoneItem = document.createElement('div');
                            milestoneItem.className = 'flex items-center';
                            milestoneItem.innerHTML = `
                                <input type="checkbox" id="milestone-${milestone.id}" class="milestone-checkbox" ${milestone.completed ? 'checked' : ''} aria-label="${milestone.text}">
                                <label for="milestone-${milestone.id}" class="flex-grow" style="color: ${milestone.completed ? '#9ca3af' : '#e5e7eb'}; ${milestone.completed ? 'text-decoration: line-through;' : ''}">${milestone.text}</label>
                                <button class="edit-milestone-btn text-blue-400" data-id="${milestone.id}" title="Edit milestone" aria-label="Edit milestone">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                            `;
                            elements.milestonesList.appendChild(milestoneItem);
                            const checkbox = milestoneItem.querySelector('.milestone-checkbox');
                            if (checkbox) {
                                checkbox.addEventListener('change', (e) => {
                                    milestone.completed = e.target.checked;
                                    updateGoalProgress(goal);
                                    saveData('goals', goals);
                                    renderGoals();
                                });
                            }
                            const editBtn = milestoneItem.querySelector('.edit-milestone-btn');
                            if (editBtn) {
                                editBtn.addEventListener('click', () => {
                                    const newText = prompt('Edit milestone:', milestone.text);
                                    if (newText && newText.trim()) {
                                        milestone.text = newText.trim();
                                        updateGoalDetailModal(goal);
                                        saveData('goals', goals);
                                        renderGoals();
                                    }
                                });
                            }
                        });
                    }
                }
            };
            const renderGoalCard = (goal) => {
                const { name, color } = getCategoryInfo(goal.category);
                const goalCard = document.createElement('div');
                goalCard.className = 'card goal-card p-5 rounded-xl';
                goalCard.dataset.id = goal.id;
                goalCard.draggable = true;
                goalCard.setAttribute('role', 'option');
                goalCard.setAttribute('aria-label', `View goal ${goal.title}`);
                goalCard.innerHTML = `
                    <div class="flex items-start justify-between mb-2">
                        <h3 class="text-lg font-semibold" style="color: #e5e7eb;">${goal.title}</h3>
                        <span class="text-sm px-2 py-1 rounded-full ${color}">${name}</span>
                    </div>
                    <p class="goal-description text-sm mb-3" style="color: #9ca3af;">${goal.description || ''}</p>
                    <div class="progress-section">
                        <div class="flex justify-between mb-1">
                            <span class="text-sm font-medium text-blue-400">Progress</span>
                            <span class="progress-text text-sm" style="color: #e5e7eb;">${goal.progress}%</span>
                        </div>
                        <div class="w-full bg-gray-600 rounded-full h-2.5" style="background-color: #4b5563;">
                            <div class="progress-bar bg-blue-500 h-2.5 rounded-full" style="width: ${goal.progress}%"></div>
                        </div>
                        ${goal.category === 'finance' ? `<div class="finance-target text-xs mt-2" style="color: #9ca3af;">Current: ₹${formatCurrency(goal.currentAmount)} / ₹${formatCurrency(goal.targetAmount)}</div>` : ''}
                    </div>
                `;
                let isDragging = false;
                goalCard.addEventListener('dragstart', (e) => {
                    isDragging = true;
                    goalCard.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', goal.id);
                });
                goalCard.addEventListener('dragend', () => {
                    isDragging = false;
                    goalCard.classList.remove('dragging');
                    saveData('goals', goals);
                });
                goalCard.addEventListener('dragover', (e) => e.preventDefault());
                goalCard.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const draggedId = e.dataTransfer.getData('text/plain');
                    const droppedId = goal.id;
                    const draggedGoal = goals.find(g => g.id === draggedId);
                    const droppedGoal = goals.find(g => g.id === droppedId);
                    const draggedIndex = goals.indexOf(draggedGoal);
                    const droppedIndex = goals.indexOf(droppedGoal);
                    goals.splice(draggedIndex, 1);
                    goals.splice(droppedIndex, 0, draggedGoal);
                    goals.forEach((g, index) => g.order = index);
                    renderGoals();
                    saveData('goals', goals);
                });
                goalCard.addEventListener('click', (e) => {
                    if (!isDragging) {
                        e.preventDefault();
                        openGoalDetail(goal.id);
                    }
                });
                goalCard.addEventListener('mouseup', () => {
                    isDragging = false;
                });
                goalCard.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        openGoalDetail(goal.id);
                    }
                });
                return goalCard;
            };
            const renderGoals = () => {
                if (!elements.goalsContainer || !elements.noGoalsMessage) return;
                elements.goalsContainer.innerHTML = '';
                goals.sort((a, b) => a.order - b.order);
                goals.forEach(goal => {
                    if (goal) elements.goalsContainer.appendChild(renderGoalCard(goal));
                });
                if (goals.length > 0) {
                    const addMoreCard = document.createElement('div');
                    addMoreCard.className = 'card rounded-xl p-5 flex items-center justify-center';
                    addMoreCard.innerHTML = `<button id="addMoreGoalsBtn" class="btn btn-primary w-full h-full text-lg font-semibold">+ Add More Goals</button>`;
                    elements.goalsContainer.appendChild(addMoreCard);
                    setTimeout(() => {
                        const addMoreGoalsBtn = document.getElementById('addMoreGoalsBtn');
                        if (addMoreGoalsBtn) {
                            addMoreGoalsBtn.addEventListener('click', () => openModal(
                                elements.goalModal,
                                elements.modalTitle,
                                'Create New Goal',
                                elements.submitGoalBtn,
                                'Create Goal',
                                elements.goalTitle
                            ));
                        }
                    }, 0);
                    elements.goalsContainer.classList.remove('hidden');
                    elements.noGoalsMessage.classList.add('hidden');
                } else {
                    elements.goalsContainer.classList.add('hidden');
                    elements.noGoalsMessage.classList.remove('hidden');
                }
            };
            const openGoalDetail = (id) => {
                const goal = goals.find(g => g.id === id);
                if (!goal || !elements.goalDetailModal || !elements.detailGoalTitle) return;
                currentGoalId = id;
                updateGoalDetailModal(goal);
                elements.goalDetailModal.classList.remove('hidden');
                elements.detailGoalTitle.focus();
            };
            const updateCategoryFields = (category) => {
                if (elements.financeAmountField && elements.targetAmountInput) {
                    elements.financeAmountField.classList.toggle('hidden', category !== 'finance');
                    elements.targetAmountInput.toggleAttribute('required', category === 'finance');
                }
            };

            // Profile & Notes
            async function loadProfile() {
                const snap = await profileRef.once('value');
                const data = snap.val();
                if (data) {
                    elements.userName.value = data.name || '';
                    elements.userHeight.value = data.height || '';
                    elements.userWeight.value = data.weight || '';
                }
            }

            elements.saveProfileBtn.addEventListener('click', async () => {
                const profile = {
                    name: elements.userName.value.trim() || 'Anonymous',
                    height: parseInt(elements.userHeight.value) || null,
                    weight: parseFloat(elements.userWeight.value) || null
                };
                await profileRef.set(profile);
                alert('Profile saved!');
                updateWelcomeName(); // Update name on password screen
            });

            async function loadNotes() {
                const snap = await notesRef.once('value');
                notes = [];
                snap.forEach(child => {
                    notes.push({ id: child.key, ...child.val() });
                });
                renderNotes();
            }

            function renderNotes() {
                elements.notesList.innerHTML = '';
                if (notes.length === 0) {
                    elements.notesList.innerHTML = '<p class="text-gray-500 text-center">No notes yet. Create one!</p>';
                    return;
                }
                notes.sort((a, b) => b.timestamp - a.timestamp);
                notes.forEach(note => {
                    const noteEl = document.createElement('div');
                    noteEl.className = 'p-4 bg-gray-800 rounded-lg border border-gray-700';
                    noteEl.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-medium text-gray-200">${note.title || 'Untitled'}</h4>
                            <div class="flex space-x-2">
                                <button class="edit-note text-blue-400 text-sm" data-id="${note.id}">Edit</button>
                                <button class="delete-note text-red-400 text-sm" data-id="${note.id}">Delete</button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-400 whitespace-pre-wrap">${note.content || ''}</p>
                        <p class="text-xs text-gray-500 mt-2">${new Date(note.timestamp).toLocaleString()}</p>
                    `;
                    elements.notesList.appendChild(noteEl);
                });

                document.querySelectorAll('.edit-note').forEach(btn => {
                    btn.addEventListener('click', () => editNote(btn.dataset.id));
                });
                document.querySelectorAll('.delete-note').forEach(btn => {
                    btn.addEventListener('click', () => deleteNote(btn.dataset.id));
                });
            }

            function openNoteModal(note = null) {
                elements.noteModal.classList.remove('hidden');
                elements.noteModalTitle.textContent = note ? 'Edit Note' : 'New Note';
                elements.noteId.value = note?.id || '';
                elements.noteTitle.value = note?.title || '';
                elements.noteContent.value = note?.content || '';
                elements.noteTitle.focus();
            }

            async function saveNote(e) {
                e.preventDefault();
                const id = elements.noteId.value || notesRef.push().key;
                const note = {
                    title: elements.noteTitle.value.trim() || 'Untitled',
                    content: elements.noteContent.value.trim(),
                    timestamp: Date.now()
                };
                await notesRef.child(id).set(note);
                closeModal(elements.noteModal, elements.noteForm);
                loadNotes();
            }

            function editNote(id) {
                const note = notes.find(n => n.id === id);
                if (note) openNoteModal(note);
            }

            async function deleteNote(id) {
                if (confirm('Delete this note?')) {
                    await notesRef.child(id).remove();
                    loadNotes();
                }
            }

            elements.addNoteBtn.addEventListener('click', () => openNoteModal());
            elements.closeNoteModal.addEventListener('click', () => closeModal(elements.noteModal, elements.noteForm));
            elements.cancelNoteBtn.addEventListener('click', () => closeModal(elements.noteModal, elements.noteForm));
            elements.noteForm.addEventListener('submit', saveNote);

            // Event Listeners
            const setupEventListeners = () => {
                if (elements.goalCategorySelect) {
                    elements.goalCategorySelect.addEventListener('change', () => updateCategoryFields(elements.goalCategorySelect.value));
                }
                elements.tabBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        elements.tabBtns.forEach(b => {
                            b.classList.remove('active', 'border-b-2', 'border-blue-400', 'text-blue-400');
                            b.classList.add('text-gray-400');
                            b.setAttribute('aria-selected', 'false');
                        });
                        btn.classList.add('active', 'border-b-2', 'border-blue-400', 'text-blue-400');
                        btn.classList.remove('text-gray-400');
                        btn.setAttribute('aria-selected', 'true');
                        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                        const targetTab = document.getElementById(btn.dataset.tab);
                        if (targetTab) targetTab.classList.add('active');
                    });
                });
                if (elements.createFirstGoalBtn) {
                    elements.createFirstGoalBtn.addEventListener('click', () => openModal(
                        elements.goalModal,
                        elements.modalTitle,
                        'Create New Goal',
                        elements.submitGoalBtn,
                        'Create Goal',
                        elements.goalTitle
                    ));
                }
                if (elements.closeModalBtn) {
                    elements.closeModalBtn.addEventListener('click', () => closeModal(elements.goalModal, elements.goalForm, [elements.goalTitleError, elements.goalCategoryError, elements.targetAmountError]));
                }
                if (elements.cancelGoalBtn) {
                    elements.cancelGoalBtn.addEventListener('click', () => closeModal(elements.goalModal, elements.goalForm, [elements.goalTitleError, elements.goalCategoryError, elements.targetAmountError]));
                }
                if (elements.closeDetailModalBtn) {
                    elements.closeDetailModalBtn.addEventListener('click', () => closeModal(elements.goalDetailModal));
                }
                if (elements.editGoalBtn) {
                    elements.editGoalBtn.addEventListener('click', () => {
                        const goal = goals.find(g => g.id === currentGoalId);
                        if (!goal) return;
                        closeModal(elements.goalDetailModal);
                        openModal(elements.goalModal, elements.modalTitle, 'Edit Goal', elements.submitGoalBtn, 'Update Goal', elements.goalTitle);
                        if (elements.editGoalId) elements.editGoalId.value = goal.id;
                        if (elements.goalTitle) elements.goalTitle.value = goal.title;
                        if (elements.goalDescription) elements.goalDescription.value = goal.description || '';
                        if (elements.goalCategorySelect) elements.goalCategorySelect.value = goal.category;
                        updateCategoryFields(goal.category);
                        if (goal.category === 'finance' && elements.targetAmountInput) elements.targetAmountInput.value = goal.targetAmount || '';
                    });
                }
                if (elements.goalForm) {
                    elements.goalForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const fields = [
                            { value: elements.goalTitle ? elements.goalTitle.value.trim() : '', errorElement: elements.goalTitleError, errorMessage: 'Goal title is required', validate: v => v },
                            { value: elements.goalCategorySelect ? elements.goalCategorySelect.value : '', errorElement: elements.goalCategoryError, errorMessage: 'Please select a category', validate: v => v },
                            { value: elements.targetAmountInput ? parseFloat(elements.targetAmountInput.value) : 0, errorElement: elements.targetAmountError, errorMessage: 'Please enter a valid target amount', validate: v => !elements.goalCategorySelect || elements.goalCategorySelect.value !== 'finance' || (!isNaN(v) && v > 0) }
                        ];
                        if (!validateForm(fields)) {
                            alert('Please fill in all required fields correctly.');
                            return;
                        }
                        const goal = {
                            id: elements.editGoalId ? elements.editGoalId.value || database.ref('goals').push().key : database.ref('goals').push().key,
                            title: elements.goalTitle ? elements.goalTitle.value.trim() : '',
                            description: elements.goalDescription ? elements.goalDescription.value.trim() : '',
                            category: elements.goalCategorySelect ? elements.goalCategorySelect.value : '',
                            progress: 0,
                            milestones: elements.editGoalId && elements.editGoalId.value ? (goals.find(g => g.id === elements.editGoalId.value)?.milestones || []) : [],
                            targetAmount: elements.goalCategorySelect && elements.goalCategorySelect.value === 'finance' ? parseFloat(elements.targetAmountInput ? elements.targetAmountInput.value : 0) : null,
                            currentAmount: elements.editGoalId && elements.editGoalId.value ? (goals.find(g => g.id === elements.editGoalId.value)?.currentAmount || 0) : 0,
                            order: elements.editGoalId && elements.editGoalId.value ? (goals.find(g => g.id === elements.editGoalId.value)?.order || goals.length) : goals.length,
                            createdAt: elements.editGoalId && elements.editGoalId.value ? (goals.find(g => g.id === elements.editGoalId.value)?.createdAt || new Date().toISOString()) : new Date().toISOString(),
                            progressHistory: elements.editGoalId && elements.editGoalId.value ? (goals.find(g => g.id === elements.editGoalId.value)?.progressHistory || []) : []
                        };
                        try {
                            if (elements.editGoalId && elements.editGoalId.value) {
                                const index = goals.findIndex(g => g.id === goal.id);
                                goals[index] = sanitizeGoal(goal);
                            } else {
                                goals.push(sanitizeGoal(goal));
                            }
                            updateGoalProgress(goal);
                            await saveData('goals', goals);
                            renderGoals();
                            closeModal(elements.goalModal, elements.goalForm, [elements.goalTitleError, elements.goalCategoryError, elements.targetAmountError]);
                            alert(elements.editGoalId && elements.editGoalId.value ? 'Goal updated successfully!' : 'Goal created successfully!');
                        } catch (error) {
                            handleError(error, 'save goal');
                        }
                    });
                }
                if (elements.addMilestoneBtn) {
                    elements.addMilestoneBtn.addEventListener('click', () => {
                        const text = elements.newMilestoneInput ? elements.newMilestoneInput.value.trim() : '';
                        if (!text) {
                            alert('Please enter a milestone');
                            return;
                        }
                        const goal = goals.find(g => g.id === currentGoalId);
                        if (!goal) return;
                        goal.milestones.push({
                            id: goal.milestones.length > 0 ? Math.max(...goal.milestones.map(m => m.id)) + 1 : 1,
                            text,
                            completed: false
                        });
                        updateGoalProgress(goal);
                        saveData('goals', goals);
                        updateGoalDetailModal(goal);
                        renderGoals();
                        if (elements.newMilestoneInput) elements.newMilestoneInput.value = '';
                    });
                }
                if (elements.deleteGoalBtn) {
                    elements.deleteGoalBtn.addEventListener('click', async () => {
                        if (confirm('Are you sure you want to delete this goal?')) {
                            goals = goals.filter(g => g.id !== currentGoalId).map((g, index) => ({ ...g, order: index }));
                            await database.ref(`goals/${currentGoalId}`).remove().catch(error => handleError(error, 'delete goal'));
                            closeModal(elements.goalDetailModal);
                            renderGoals();
                        }
                    });
                }
                if (elements.currentAmountSlider) {
                    elements.currentAmountSlider.addEventListener('input', debounce(() => {
                        const goal = goals.find(g => g.id === currentGoalId);
                        if (!goal) return;
                        goal.currentAmount = parseFloat(elements.currentAmountSlider.value);
                        if (elements.currentAmountLabel) elements.currentAmountLabel.textContent = `₹${formatCurrency(goal.currentAmount)}`;
                        if (elements.currentAmountInput) elements.currentAmountInput.value = goal.currentAmount;
                        updateGoalProgress(goal);
                        renderGoals();
                        saveData('goals', goals);
                    }, 500));
                }
                if (elements.currentAmountInput) {
                    elements.currentAmountInput.addEventListener('input', debounce(() => {
                        const goal = goals.find(g => g.id === currentGoalId);
                        if (!goal) return;
                        let value = parseFloat(elements.currentAmountInput.value);
                        if (isNaN(value) || value < 0) value = 0;
                        if (value > parseFloat(elements.currentAmountInput.max)) value = parseFloat(elements.currentAmountInput.max);
                        goal.currentAmount = value;
                        if (elements.currentAmountSlider) elements.currentAmountSlider.value = value;
                        if (elements.currentAmountLabel) elements.currentAmountLabel.textContent = `₹${formatCurrency(goal.currentAmount)}`;
                        updateGoalProgress(goal);
                        renderGoals();
                        saveData('goals', goals);
                    }, 500));
                }
            };

            const init = async () => {
                await loadData('goals', goals, (goal) => {
                    goal.milestones = goal.milestones || [];
                    goal.order = Number(goal.order) || 0;
                    goal.progressHistory = goal.progressHistory || [];
                    updateGoalProgress(goal);
                });
                renderGoals();
                setupEventListeners();
                await loadProfile();
                await loadNotes();
            };
            init();
        }
    </script>
    <!-- SERVICE WORKER REGISTRATION -->
  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js', { scope: '/' })
        .then(reg => console.log('SW registered:', reg.scope))
        .catch(err => console.error('SW failed:', err));
    });
  }
</script>
  </body>
</html>

















